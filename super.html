<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Super Analysis Space</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/1.1.0/modern-normalize.min.css" integrity="sha512-/WQqX1oJpQbZyqf1bZ9u2t2s1QZ9lQe6Yk0r0s3xQ0xq6m9F1pF8zQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f6f8fb; margin:0; padding:20px; }
    .wrap { max-width:1200px; margin:20px auto; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; }
    header h1 { margin:0; font-size:1.4rem; }
    .grid { display:grid; grid-template-columns: 1fr 360px; gap:18px; margin-top:18px; }
    .card { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(15,22,39,0.06); }
    #chart { height:520px; }
    .controls { display:flex; gap:8px; margin-bottom:12px; }
    select, input[type=text], button { padding:8px 10px; border-radius:6px; border:1px solid #dfe6ef; }
    .news-list { max-height:440px; overflow:auto; }
    .predictions { margin-top:12px; }
    textarea { width:100%; height:120px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Super Analysis Space</h1>
      <nav>
        <a href="index.html">Home</a>
        &nbsp;|&nbsp;
        <a href="charts.html">Charts</a>
      </nav>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <div class="controls">
            <select id="symbolSelect">
              <option value="NASDAQ:AAPL">AAPL (Apple)</option>
              <option value="NASDAQ:MSFT">MSFT (Microsoft)</option>
              <option value="BINANCE:BTCUSDT">BTCUSDT</option>
              <option value="BINANCE:ETHUSDT">ETHUSDT</option>
            </select>
            <input type="text" id="customSymbol" placeholder="Or enter symbol (e.g. NASDAQ:TSLA)" />
            <button id="loadChart">Load Chart</button>
            <button id="recommendationsBtn">Get Recommendation</button>
          </div>

          <div id="chart" class="tradingview-card">
            <!-- TradingView widget will be injected here -->
          </div>

          <div class="predictions card" style="margin-top:12px;">
            <h3>Quick Predictions</h3>
            <p>Provide an Alpha Vantage API key (optional) to fetch historical data, or paste CSV (date,close) below and click Forecast.</p>
            <input type="text" id="avKey" placeholder="Alpha Vantage API key (optional)" />
            <div style="margin-top:8px;">
              <textarea id="csvData" placeholder="date,close\n2025-01-01,100\n2025-01-02,101"></textarea>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button id="fetchAv">Fetch & Forecast</button>
              <button id="useCsv">Forecast from CSV</button>
            </div>
            <canvas id="forecastChart" height="140" style="margin-top:12px; background:#fff; border-radius:8px;"></canvas>
          </div>
        </div>
      </div>

      <aside>
        <div class="card">
          <h3>Real-Time News</h3>
          <p>Live headlines related to the currently selected symbol.</p>
          <div id="news" class="news-list">
            <p>Loading news...</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3>Quick Recommendations</h3>
          <div id="recArea">
            <p>Press "Get Recommendation" for a technical summary (simple EMA/SMA rules).</p>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Minimal TradingView embed loader
    let tvWidget = null;
    function loadTV(symbol) {
      const container = document.getElementById('chart');
      container.innerHTML = '';
      tvWidget = new TradingView.widget({
        width: '100%',
        height: 520,
        symbol: symbol,
        interval: '60',
        timezone: 'Etc/UTC',
        theme: 'light',
        style: '1',
        locale: 'en',
        toolbar_bg: '#f1f3f6',
        container_id: 'chart'
      });
    }

    document.getElementById('loadChart').addEventListener('click', ()=>{
      const custom = document.getElementById('customSymbol').value.trim();
      const sel = document.getElementById('symbolSelect').value;
      loadTV(custom || sel);
      loadNews(custom || sel);
    });

    // Simple recommendation using SMA/EMA crossover fetched from Alpha Vantage (if key provided)
    document.getElementById('recommendationsBtn').addEventListener('click', async ()=>{
      const symbol = document.getElementById('customSymbol').value.trim() || document.getElementById('symbolSelect').value;
      const key = document.getElementById('avKey').value.trim();
      document.getElementById('recArea').innerHTML = '<p>Calculating...</p>';
      try {
        let series = await fetchSeries(symbol, key);
        const rec = computeRecommendation(series);
        document.getElementById('recArea').innerHTML = `<p><strong>${rec}</strong></p>`;
      } catch(e) {
        document.getElementById('recArea').innerHTML = '<p>Could not fetch data for recommendation. Try entering CSV or API key.</p>';
      }
    });

    async function fetchSeries(symbol, key) {
      // Try Alpha Vantage for stocks; for crypto, use Binance public API as fallback
      // Prefer server proxy if available
      try {
        const proxyRes = await fetch(`/api/alpha?symbol=${encodeURIComponent(symbol)}`);
        if(proxyRes.ok) {
          const data = await proxyRes.json();
          if(data['Time Series (Daily)']) {
            const series = Object.entries(data['Time Series (Daily)']).map(([date,vals])=>({date,close:parseFloat(vals['4. close'])})).sort((a,b)=>new Date(a.date)-new Date(b.date));
            return series;
          }
        }
      } catch(e) {
        // proxy not available, continue to fallback options
      }

      if(key) {
        // Map TradingView symbols to AlphaVantage symbols conservatively (user may provide full symbol like NASDAQ:AAPL)
        const avSymbol = symbol.includes(':') ? symbol.split(':')[1] : symbol;
        const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${avSymbol}&outputsize=compact&apikey=${key}`;
        const res = await fetch(url);
        const data = await res.json();
        if(data['Time Series (Daily)']) {
          const series = Object.entries(data['Time Series (Daily)']).map(([date,vals])=>({date,close:parseFloat(vals['4. close'])})).sort((a,b)=>new Date(a.date)-new Date(b.date));
          return series;
        }
        throw new Error('No data');
      } else {
        // Fallback for crypto: try Binance REST for symbol like BINANCE:BTCUSDT
        if(symbol.includes('BINANCE:')) {
          const s = symbol.split(':')[1];
          const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${s}&interval=1d&limit=100`);
          const data = await res.json();
          const series = data.map(row=>({date:new Date(row[0]).toISOString().slice(0,10), close: parseFloat(row[4])}));
          return series;
        }
        throw new Error('No key and not crypto');
      }
    }

    function computeRecommendation(series) {
      // compute simple 20-day SMA and 50-day SMA
      const closes = series.map(s=>s.close);
      function sma(arr, n) { if(arr.length < n) return null; return arr.slice(-n).reduce((a,b)=>a+b,0)/n; }
      const sma20 = sma(closes,20);
      const sma50 = sma(closes,50);
      if(!sma20 || !sma50) return 'Not enough data for recommendation';
      if(sma20 > sma50) return 'Bullish (Buy) - 20d SMA above 50d SMA';
      if(sma20 < sma50) return 'Bearish (Sell) - 20d SMA below 50d SMA';
      return 'Neutral';
    }

    // News loader using NewsAPI.org via demo endpoint? We'll implement a simple fetch to an RSS2JSON proxy for Google News as a workaround.
    async function loadNews(symbol) {
      const newsEl = document.getElementById('news');
      newsEl.innerHTML = '<p>Loading news...</p>';
      try {
        const q = symbol.includes(':') ? symbol.split(':')[1] : symbol;
        // Try server proxy first
        try {
          const r = await fetch(`/api/news?q=${encodeURIComponent(q)}`);
          if(r.ok) {
            const data = await r.json();
            if(data && data.results && data.results.length) {
              newsEl.innerHTML = data.results.slice(0,8).map(n=>`<div style=\"margin-bottom:8px;\"><a href=\"${n.link}\" target=\"_blank\">${n.title}</a><div style=\"font-size:12px;color:#666\">${n.pubDate || ''}</div></div>`).join('');
              return;
            }
          }
        } catch(e) {
          // proxy failed; fallback to public demo endpoint
        }

        const url = `https://newsdata.io/api/1/news?apikey=pub_61f0b0b7f19c8d3b1a90b5adf6c1d7&language=en&q=${encodeURIComponent(q)}`;
        const res = await fetch(url);
        const data = await res.json();
        if(data && data.results && data.results.length) {
          newsEl.innerHTML = data.results.slice(0,8).map(n=>`<div style=\"margin-bottom:8px;\"><a href=\"${n.link}\" target=\"_blank\">${n.title}</a><div style=\"font-size:12px;color:#666\">${n.pubDate || ''}</div></div>`).join('');
        } else {
          newsEl.innerHTML = '<p>No recent news found or API key required.</p>';
        }
      } catch(e) {
        newsEl.innerHTML = '<p>News unavailable due to CORS or API limits. You can paste news links here manually.</p>';
      }
    }

    // Forecasting: simple linear regression on last N points
    function forecastFromSeries(series, days=7) {
      const n = series.length;
      const close = series.map(s=>s.close);
      const x = close.map((_,i)=>i+1);
      const y = close;
      const xMean = x.reduce((a,b)=>a+b,0)/n;
      const yMean = y.reduce((a,b)=>a+b,0)/n;
      let num=0, den=0;
      for(let i=0;i<n;i++){ num += (x[i]-xMean)*(y[i]-yMean); den += (x[i]-xMean)*(x[i]-xMean); }
      const slope = den === 0 ? 0 : num/den;
      const intercept = yMean - slope*xMean;
      const lastX = n;
      const preds=[]; const labels=[];
      for(let d=1; d<=days; d++){
        const px = lastX + d;
        preds.push(intercept + slope*px);
        const nextDate = new Date(series[n-1].date);
        nextDate.setDate(nextDate.getDate()+d);
        labels.push(nextDate.toISOString().slice(0,10));
      }
      return {labels, preds};
    }

    let forecastChart = null;
    function renderForecast(series, labels, preds) {
      const ctx = document.getElementById('forecastChart').getContext('2d');
      const actualDates = series.map(s=>s.date);
      const actual = series.map(s=>s.close);
      const combinedLabels = actualDates.concat(labels);
      const combinedActual = actual.concat(new Array(labels.length).fill(null));
      const predSeries = new Array(actual.length).fill(null).concat(preds.map(p=>Number(p.toFixed(2))));
      if(forecastChart) forecastChart.destroy();
      forecastChart = new Chart(ctx, {
        type:'line', data: {
          labels: combinedLabels,
          datasets:[{ label:'Actual', data:combinedActual, borderColor:'#0070f3', fill:false }, { label:'Forecast', data:predSeries, borderColor:'#ff7a00', borderDash:[5,5], fill:false }]
        }
      });
    }

    document.getElementById('useCsv').addEventListener('click', ()=>{
      const txt = document.getElementById('csvData').value.trim();
      if(!txt) { alert('Paste CSV data first'); return; }
      const lines = txt.split('\n').map(l=>l.trim()).filter(Boolean);
      const parsed = lines.slice(1).map(l=>{ const [d,c]=l.split(','); return {date:d.trim(), close: parseFloat(c)}; }).sort((a,b)=>new Date(a.date)-new Date(b.date));
      const {labels, preds} = forecastFromSeries(parsed, 7);
      renderForecast(parsed, labels, preds);
    });

    document.getElementById('fetchAv').addEventListener('click', async ()=>{
      const key = document.getElementById('avKey').value.trim();
      const symbol = document.getElementById('customSymbol').value.trim() || document.getElementById('symbolSelect').value;
      if(!key) { alert('Please provide an Alpha Vantage API key or use CSV'); return; }
      try {
        const series = await fetchSeries(symbol, key);
        const {labels,preds} = forecastFromSeries(series,7);
        renderForecast(series, labels, preds);
      } catch(e) {
        alert('Failed to fetch from Alpha Vantage: ' + e.message);
      }
    });

    // initialize
    loadTV(document.getElementById('symbolSelect').value);
    loadNews(document.getElementById('symbolSelect').value);
  </script>
</body>
</html>
